---
import { type CollectionEntry, getCollection, render } from "astro:content";

import BackLink from "@/components/BackLink.astro";
import FloatingNav from "@/components/FloatingNav.astro";
import Footer from "@/components/Footer.astro";
import FormattedDate from "@/components/FormattedDate.astro";
import FullscreenNav from "@/components/FullscreenNav.astro";
import Head from "@/components/Head.astro";
import SkipLink from "@/components/SkipLink.astro";
import TagChip from "@/components/TagChip.astro";
import { TITLES, DESCRIPTIONS, URLS, RELATED_WRITINGS_LIMIT } from "@/constants";
import { getRelatedWritings } from "@/utils/data";

const quoteIcon = await import("@/assets/icons/quote.svg?raw");
const svgDataUri = `url("data:image/svg+xml,${encodeURIComponent(quoteIcon.default)}")`;

export async function getStaticPaths() {
  const writings = await getCollection("writing");

  return writings.map(writing => ({
    params: { slug: writing.id },
    props: writing,
  }));
}

type Props = CollectionEntry<"writing">;

const writing = Astro.props;
const publishedDate = writing.data.pubDatetime;
const allWritings = await getCollection("writing");
const relatedWritings = getRelatedWritings(writing, allWritings, RELATED_WRITINGS_LIMIT);

const { Content } = await render(writing);
---

<!doctype html>
<html lang="en">
  <head>
    <Head
      title={TITLES.writing(writing.data.title)}
      description={DESCRIPTIONS.writing(writing.data.description)}
    />
    <link
      href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital@0;1&display=swap"
      rel="stylesheet"
    />
    <style set:html={`.prose blockquote::after { mask-image: ${svgDataUri}; }`}></style>
  </head>

  <body>
    <SkipLink />
    <main id="main-content">
      <article class="container">
        <div class="article-header">
          <BackLink />

          <div class="article-meta">
            <FormattedDate date={publishedDate} />

            <h1 class="article-title">{writing.data.title}</h1>

            <ul class="article-tags" role="list">
              {
                writing.data.tags.map(tag => (
                  <li>
                    <TagChip tag={tag} />
                  </li>
                ))
              }
            </ul>
          </div>
        </div>

        <div class="prose">
          <Content />
        </div>

        {
          relatedWritings.length > 0 && (
            <section class="related-writings" aria-label="Related writings">
              <h2 class="related-heading">More writings</h2>

              <ul class="related-list" role="list">
                {relatedWritings.map(writing => (
                  <li class="related-item">
                    <a href={URLS.writing(writing.id)} class="related-link">
                      <FormattedDate
                        date={writing.data.pubDatetime}
                        formatOptions={{ year: "2-digit", month: "numeric", day: "numeric" }}
                      />
                      <span class="related-title">{writing.data.title}</span>
                    </a>
                  </li>
                ))}
              </ul>
            </section>
          )
        }
      </article>
    </main>

    <FloatingNav />
    <FullscreenNav />
    <Footer />
  </body>
</html>

<style>
  /* -------------------------
   * Article Layout
   * ------------------------- */
  .container {
    display: flex;
    flex: 1;
    flex-direction: column;
    padding-block: clamp(4rem, 10vw, 15rem);
    margin-inline: auto;
    max-width: 55rem;
  }

  /* -------------------------
   * Article Header
   * ------------------------- */
  .article-header {
    width: 100%;
    max-width: 44rem;
    margin-inline: auto;
    margin-block-end: 3rem;
  }

  .article-meta {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .article-meta :global(time) {
    color: var(--color-surface-500);
    font-size: 1.5rem;
    line-height: 1.4;
  }

  .article-title {
    font-family: var(--font-display);
    font-weight: 700;
    font-optical-sizing: auto;
    font-size: 2.5rem;
    line-height: 1.2;
  }

  .article-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .article-tags li {
    display: inline-block;
  }

  /* -------------------------
   * Article Content (Prose)
   * ------------------------- */
  .prose {
    margin-block-start: 9.125rem;
  }

  /* Headings */

  .prose :global(h1),
  .prose :global(h2),
  .prose :global(h3),
  .prose :global(h4),
  .prose :global(h5),
  .prose :global(h6) {
    font-family: var(--font-display);
    font-weight: 700;
    font-optical-sizing: auto;
    max-width: 44rem;
    margin-inline: auto;
  }

  .prose :global(h1) {
    font-size: 2.5rem;
    line-height: 1.2;
    margin-block: 9.125rem 1.5rem;
  }

  .prose :global(h2) {
    font-size: 2.0625rem;
    line-height: 1.21;
    margin-block: 7.5rem 1.25rem;
  }

  .prose :global(h3) {
    font-size: 1.75rem;
    line-height: 1.29;
    margin-block: 6rem 1rem;
  }

  .prose :global(h4) {
    font-size: 1.5rem;
    line-height: 1.3333;
    margin-block: 4.5rem 1rem;
  }

  .prose :global(h5) {
    font-size: 1.25rem;
    line-height: 1.4;
    margin-block: 3rem 1rem;
  }

  .prose :global(h6) {
    font-size: 1.0625rem;
    line-height: 1.41;
    margin-block: 2rem 1rem;
  }

  /* Paragraphs */
  .prose :global(p) {
    margin-block-end: 1rem;
    max-width: 44rem;
    margin-inline: auto;
  }

  /* Horizontal rule */

  .prose :global(hr) {
    border: none;
    border-block-start: 1px solid var(--color-border);
    margin-block: 6rem;
  }

  /* Text emphasis */
  .prose :global(strong) {
    font-weight: 700;
  }

  .prose :global(em) {
    font-style: italic;
  }

  .prose :global(del) {
    text-decoration: line-through;
  }

  /* Blockquote */
  .prose :global(blockquote) {
    color: var(--color-surface-700);
    position: relative;
    padding-inline-start: 1rem;
    margin-block: 1.2rem;
    font-style: italic;
  }

  .prose :global(blockquote cite) {
    font-size: 0.875rem;
  }

  .prose :global(blockquote::before) {
    content: "";
    position: absolute;
    inset-inline-start: 6px;
    inset-block: 0;
    width: 4px;
    background: linear-gradient(
      to bottom,
      var(--color-border) calc(50% - 0.75rem),
      transparent calc(50% - 0.75rem),
      transparent calc(50% + 0.75rem),
      var(--color-border) calc(50% + 0.75rem)
    );
  }

  .prose :global(blockquote::after) {
    content: "";
    position: absolute;
    inset-block-start: calc(50% - 0.5rem);
    inset-inline-start: 0;
    width: 1rem;
    height: 1rem;
    z-index: 1;
    background-color: var(--color-text);
    mask-size: contain;
    mask-repeat: no-repeat;
  }

  .prose :global(blockquote blockquote) {
    margin-block-start: 0.8rem;
  }

  /* Links */
  .prose :global(a) {
    text-decoration: underline;
    text-decoration-color: var(--color-border-hover);
    text-decoration-thickness: 2px;
    text-underline-offset: 0.15rem;
  }

  .prose :global(a:hover),
  .prose :global(a:focus-visible) {
    color: var(--color-surface-600);
  }

  /* Images */
  .prose :global(:not(figure) > img) {
    border-radius: 0.25rem;
    margin-block: 1.5rem;
  }

  .prose :global(figure) {
    margin-block: 1.5rem;
  }

  .prose :global(figcaption) {
    font-style: italic;
    font-size: 0.875rem;
    color: var(--color-surface-500);
    text-align: center;
  }

  /* Tables */
  .prose :global(table) {
    width: 100%;
    border-collapse: collapse;
    margin-block: 1.5rem;
    font-size: 0.9rem;
  }

  .prose :global(th) {
    font-size: 1.0625rem;
    text-align: start;
    border-block-end: 2px solid var(--color-border);
    padding: 0.5rem 0.75rem;
  }

  .prose :global(td) {
    font-size: 0.875rem;
    border-block-end: 1px solid var(--color-border);
    color: var(--color-surface-700);
    padding: 0.5rem 0.75rem;
  }

  .prose :global(tr:last-child td) {
    border-block-end: none;
  }

  /* Inline code */
  .prose :global(:not(pre) > code) {
    background: var(--color-code-bg);
    color: var(--color-code-text);
    padding: 0.15rem 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.875rem;
  }

  /* Code blocks (expressive-code) */
  .prose :global(.expressive-code) {
    margin-block: 1.5rem;
  }

  /* Lists */
  .prose :global(ul),
  .prose :global(ol) {
    max-width: 44rem;
    margin-block: 1rem;
    margin-inline: auto;
    padding-inline-start: 1.5rem;
  }

  .prose :global(ul) {
    list-style-type: disc;
  }

  .prose :global(ol) {
    list-style-type: decimal;
  }

  .prose :global(li) {
    margin-block-end: 0.3rem;
  }

  .prose :global(li ul),
  .prose :global(li ol) {
    margin-block: 0.3rem;
  }

  /* Task list (checkboxes) */
  .prose :global(ul:has(input[type="checkbox"])) {
    list-style: none;
    padding-inline-start: 0;
  }

  .prose :global(li:has(> input[type="checkbox"])) {
    display: flex;
    align-items: baseline;
    gap: 0.4rem;
  }

  /* Other inline elements */
  .prose :global(abbr[title]) {
    text-decoration: underline dotted;
    cursor: help;
  }

  .prose :global(kbd) {
    display: inline-block;
    padding: 0.1rem 0.4rem;
    font-size: 0.875rem;
    line-height: 1.4;
    border: 1px solid var(--color-border);
    border-radius: 0.25rem;
    box-shadow: 0 1px 0 var(--color-border);
  }

  .prose :global(mark) {
    background: var(--color-mark-bg);
    color: var(--color-mark-text);
    padding-inline: 0.15rem;
    border-radius: 0.15rem;
  }

  .prose :global(sub),
  .prose :global(sup) {
    font-size: 0.75rem;
    line-height: 0;
    position: relative;
    vertical-align: baseline;
  }

  .prose :global(sub a),
  .prose :global(sup a) {
    text-decoration-thickness: 1px;
  }

  .prose :global(sup) {
    inset-block-start: -0.5rem;
  }

  .prose :global(sub) {
    inset-block-end: -0.25rem;
  }

  /* Footnotes */
  .prose :global(.footnotes p) {
    margin-block-end: 0;
    max-width: none;
    margin-inline: 0;
  }

  .prose :global(.footnotes ul),
  .prose :global(.footnotes ol) {
    max-width: none;
    margin-inline: 0;
  }

  /* -------------------------
   * Related Writings
   * ------------------------- */
  .related-writings {
    width: 100%;
    margin-inline: auto;
    margin-block-start: 9.125rem;
    border-block-start: 1px solid var(--color-border);
    padding-block-start: 3rem;
  }

  .related-heading {
    font-family: var(--font-display);
    font-weight: 700;
    font-optical-sizing: auto;
    font-size: 1.0625rem;
    line-height: 1.41;
    margin-block-end: 2rem;
    color: var(--color-surface-600);
  }

  .related-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .related-link {
    display: inline-block;
    position: relative;
    text-decoration: none;
  }

  .related-link:focus-visible {
    outline: 1px solid var(--color-border-hover);
    outline-offset: 0.5rem;
    border-radius: 0.125rem;
  }

  .related-title {
    font-family: var(--font-display);
    font-weight: 700;
    font-optical-sizing: auto;
    font-size: 1.5rem;
    line-height: 1.3333;
    color: var(--color-text);
    display: block;
  }

  .related-link:link .related-title {
    color: var(--color-text);
  }

  .related-link:visited .related-title {
    color: var(--color-surface-400);
  }

  .related-link:hover .related-title,
  .related-link:focus-visible .related-title {
    color: var(--color-surface-600);
  }

  .related-link :global(time) {
    position: absolute;
    padding-block-start: 0.5625rem;
    inset-inline-end: 100%;
    margin-inline-end: 1rem;
    white-space: nowrap;
    color: var(--color-surface-500);
    font-size: 0.875rem;
    line-height: 1;
    opacity: 0;
    transition: opacity 0.2s ease;
  }

  .related-link:hover :global(time),
  .related-link:focus-visible :global(time) {
    opacity: 1;
  }
</style>
